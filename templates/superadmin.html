<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Super Administrador - WhatsApp Redirect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .log-container {
            height: 500px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #f0f0f0;
            font-family: monospace;
            padding: 10px;
            border-radius: 5px;
        }
        .log-info { color: #4CAF50; }
        .log-warning { color: #FFC107; }
        .log-error { color: #F44336; }
        .user-card {
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .user-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .user-card.superadmin {
            border-left-color: #dc3545;
        }
        .dashboard-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        .stats-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
        }
    </style>
</head>
<body>
    <!-- Cabeçalho -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-0"><i class="bi bi-shield-lock"></i> Painel de Super Administrador</h2>
                </div>
                <div class="col-md-6 text-md-end">
                    <span class="me-3">Olá, <strong>{{ session.fullname }}</strong></span>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-box-arrow-right"></i> Sair
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row">
            <!-- Seção de gerenciamento de usuários -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people"></i> Gerenciamento de Usuários</h5>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-person-plus"></i> Novo Usuário
                        </button>
                    </div>
                    <div class="card-body">
                        {% for user in users %}
                        <div class="user-card p-3 {% if user.is_superadmin %}superadmin{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">{{ user.fullname }}</h5>
                                    <p class="text-muted mb-0">@{{ user.username }}
                                        {% if user.is_superadmin %}
                                        <span class="badge bg-danger ms-1">Super Admin</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <div>
                                    <span class="badge bg-primary stats-badge me-1">
                                        <i class="bi bi-telephone"></i> {{ user.number_count }} números
                                    </span>
                                    <span class="badge bg-success stats-badge">
                                        <i class="bi bi-link"></i> {{ user.link_count }} links
                                    </span>
                                </div>
                            </div>
                            <div class="mt-3 d-flex">
                                <button class="btn btn-sm btn-outline-info me-2" onclick="viewUserDetails({{ user.id }})">
                                    <i class="bi bi-eye"></i> Detalhes
                                </button>
                                {% if not user.is_superadmin %}
                                <button class="btn btn-sm btn-outline-warning me-2" onclick="editUser({{ user.id }})">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">
                                    <i class="bi bi-trash"></i> Excluir
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Seção de logs do sistema -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-journal-text"></i> Logs do Sistema</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshLogs()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearLogs()">
                                <i class="bi bi-trash"></i> Limpar Logs
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="log-container" id="logContainer">
                            {% for log in logs %}
                            <div class="log-entry {% if log.level == 'ERROR' %}log-error{% elif log.level == 'WARNING' %}log-warning{% else %}log-info{% endif %}">
                                <small>[{{ log.timestamp }}]</small> 
                                <strong>[{{ log.level }}]</strong> 
                                {{ log.message }} 
                                {% if log.username %}
                                <small>(Usuário: {{ log.username }}, IP: {{ log.ip_address }})</small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Usuário -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Novo Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('manage_users') }}" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="username" class="form-label">Nome de Usuário</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Senha</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="fullname" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="fullname" name="fullname" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Usuário -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editFullname" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="editFullname">
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">Nova Senha (deixe em branco para manter a atual)</label>
                        <input type="password" class="form-control" id="editPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserChanges()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Usuário -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="userDetailsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="numbers-tab" data-bs-toggle="tab" data-bs-target="#numbers" type="button" role="tab">Números WhatsApp</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="links-tab" data-bs-toggle="tab" data-bs-target="#links" type="button" role="tab">Links Personalizados</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3" id="userDetailsTabContent">
                        <div class="tab-pane fade show active" id="numbers" role="tabpanel">
                            <h6 class="mb-3">Números de WhatsApp</h6>
                            <div id="userNumbersList" class="list-group">
                                <!-- Lista de números será inserida via JavaScript -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="links" role="tabpanel">
                            <h6 class="mb-3">Links Personalizados</h6>
                            <div id="userLinksList" class="list-group">
                                <!-- Lista de links será inserida via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o usuário <strong id="deleteUserName"></strong>?</p>
                    <p class="text-danger">Atenção: Esta ação excluirá todos os números e links associados a este usuário e não pode ser desfeita!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variável para armazenar ID do usuário que será excluído
        let deleteUserId = null;

        // Função para ver detalhes do usuário
        function viewUserDetails(userId) {
            fetch(`/api/users/${userId}`)
                .then(response => response.json())
                .then(data => {
                    // Preencher números
                    const numbersList = document.getElementById('userNumbersList');
                    numbersList.innerHTML = '';
                    if (data.numbers.length === 0) {
                        numbersList.innerHTML = '<div class="alert alert-info">Este usuário não tem números cadastrados.</div>';
                    } else {
                        data.numbers.forEach(number => {
                            numbersList.innerHTML += `
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">${number.phone_number}</h6>
                                    </div>
                                    <p class="mb-1">${number.description || 'Sem descrição'}</p>
                                </div>
                            `;
                        });
                    }

                    // Preencher links
                    const linksList = document.getElementById('userLinksList');
                    linksList.innerHTML = '';
                    if (data.links.length === 0) {
                        linksList.innerHTML = '<div class="alert alert-info">Este usuário não tem links cadastrados.</div>';
                    } else {
                        data.links.forEach(link => {
                            linksList.innerHTML += `
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">${link.link_name}</h6>
                                        <span class="badge ${link.is_active ? 'bg-success' : 'bg-danger'}">
                                            ${link.is_active ? 'Ativo' : 'Inativo'}
                                        </span>
                                    </div>
                                    <p class="mb-1">${link.custom_message || 'Sem mensagem personalizada'}</p>
                                    <small class="text-muted">URL: ${window.location.origin}/${link.link_name}</small>
                                </div>
                            `;
                        });
                    }

                    // Mostrar modal
                    const userDetailsModal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                    userDetailsModal.show();
                })
                .catch(error => {
                    console.error('Erro ao buscar detalhes do usuário:', error);
                    alert('Erro ao buscar detalhes do usuário');
                });
        }

        // Função para abrir modal de edição
        function editUser(userId) {
            fetch(`/api/users/${userId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('editUserId').value = userId;
                    document.getElementById('editFullname').value = data.user.fullname;
                    document.getElementById('editPassword').value = '';
                    
                    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    editModal.show();
                })
                .catch(error => {
                    console.error('Erro ao buscar dados do usuário:', error);
                    alert('Erro ao buscar dados do usuário');
                });
        }

        // Função para salvar alterações do usuário
        function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const fullname = document.getElementById('editFullname').value;
            const password = document.getElementById('editPassword').value;
            
            fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fullname: fullname,
                    password: password
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                    modal.hide();
                    window.location.reload();
                } else {
                    alert('Erro ao atualizar usuário: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar usuário:', error);
                alert('Erro ao atualizar usuário');
            });
        }

        // Função para confirmar exclusão
        function deleteUser(userId, username) {
            deleteUserId = userId;
            document.getElementById('deleteUserName').textContent = username;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        // Botão de confirmação de exclusão
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (deleteUserId) {
                fetch(`/api/users/${deleteUserId}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                        modal.hide();
                        window.location.reload();
                    } else {
                        alert('Erro ao excluir usuário: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Erro ao excluir usuário:', error);
                    alert('Erro ao excluir usuário');
                });
            }
        });

        // Função para atualizar logs
        function refreshLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(logs => {
                    const logContainer = document.getElementById('logContainer');
                    logContainer.innerHTML = '';
                    
                    logs.forEach(log => {
                        let logClass = 'log-info';
                        if (log.level === 'ERROR') logClass = 'log-error';
                        if (log.level === 'WARNING') logClass = 'log-warning';
                        
                        logContainer.innerHTML += `
                            <div class="log-entry ${logClass}">
                                <small>[${log.timestamp}]</small> 
                                <strong>[${log.level}]</strong> 
                                ${log.message} 
                                ${log.username ? `<small>(Usuário: ${log.username}, IP: ${log.ip_address})</small>` : ''}
                            </div>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Erro ao atualizar logs:', error);
                    alert('Erro ao atualizar logs');
                });
        }

        // Função para limpar logs
        function clearLogs() {
            if (confirm('Tem certeza que deseja limpar todos os logs do sistema?')) {
                fetch('/api/logs', {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        refreshLogs();
                    } else {
                        alert('Erro ao limpar logs');
                    }
                })
                .catch(error => {
                    console.error('Erro ao limpar logs:', error);
                    alert('Erro ao limpar logs');
                });
            }
        }
    </script>
</body>
</html>
